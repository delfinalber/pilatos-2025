/* Use of this pixel is subject to the Amazon ad specs and policies at http://www.amazon.com/b/?&node=7253015011. Version number: 6, Changeset: Adding in phone number support for setUserData */
!function(){"use strict";const e=1e3,t=86400*e;var n={NAME_MAX_LENGTH:256,EVENT_PARAMETER_MAX_VALUE_LENGTH:1e3,EVENT_NAME_EXCEEDED_MAX_LENGTH_WARNING:"Length of event's name is longer than 256 characters.",EVENT_PARAMETER_NAME_EXCEEDED_MAX_LENGTH_WARNING:"Length of event's parameter name exceeds 256 characters.",EVENT_PARAMETER_VALUE_EXCEEDED_MAX_LENGTH_WARNING:"Length of event's parameter value exceeds 1000 characters.",EVENT_PARAMETER_KEY_EXCEEDED_MAX_LENGTH_WARNING:"Length of event's parameter key exceeds 256 characters.",AMZN_TOKEN_COOKIE_NAME:"aatToken",AMZN_TOKEN_URL_QUERY_PARAM_NAME:"amznToken",NO_CONSENT_COOKIE_NAME:"AMZN-NoCookieConsent",MEASUREMENT_TOKEN_SOURCE_QUERY_PARAM_NAME:"arefsSource",MT_LP_QUERY_PARAM:"aref",MTS_EVENT_ATTRIBUTE:"arefs",MEASUREMENT_TOKEN_COOKIE_NAME:"amznAref",MEASUREMENT_TOKEN_EVENT_FIRE_URL_QUERY_PARAM_NAME:"arefs",MEASUREMENT_TOKEN_FETCH_COUNTRY_HEADER:"https://c.amazon-adsystem.com/aat/amzn.js",MS_IN_SEC:e,MS_IN_HOUR:3600*e,MS_IN_DAY:t,MEASUREMENT_TOKEN_TTL_IN_MS:30*t,NUM_MAX_MEASUREMENT_TOKENS:147,MEASUREMENT_TOKEN_TIMESTAMP_PAIR_DELIMITER:"|",MEASUREMENT_TIMESTAMP_SEPARATOR:".",MT_TS_PAIR_TS_INDEX:1,NEWEST_MEASUREMENT_TOKEN_INDEX:0,MEASUREMENT_TOKEN_FULLY_ENABLED_REGIONS:["NA","FE"],ARBITRARY_PAST_UNIX_TIMESTAMP:1,AMAZON_CONSENT_AIPES_ENABLED:!1,AIPES_AMAZON_CONSENT_STRING_FIELD_NAME:"amazonConsentString",AIPES_AMAZON_CONSENT_GEO_FIELD_NAME:"geo",AIPES_AMAZON_CONSENT_CONSENT_FIELD_NAME:"consent",AIPES_AMAZON_CONSENT_AMAZON_CONSENT_FIELD_NAME:"amazonConsentFormat",AIPES_AMAZON_CONSENT_AD_STORAGE_FIELD_NAME:"amzn_ad_storage",AIPES_AMAZON_CONSENT_USER_DATA_FIELD_NAME:"amzn_user_data",AIPES_AMAZON_CONSENT_GPP_FIELD_NAME:"gpp",AIPES_AMAZON_CONSENT_TCF_FIELD_NAME:"tcf",AIPES_AMAZON_CONSENT_COUNTRY_CODE_FIELD_NAME:"countryCode",AIPES_AMAZON_CONSENT_IP_ADDRESS_FIELD_NAME:"ipAddress",REPORTING_ATTRIBUTES:["brand","category","productid","attr1","attr2","attr3","attr4","attr5","attr6","attr7","attr8","attr9","attr10"],REPORTING_ATTRIBUTE_MAX_LENGTH:256,REPORTING_ATTRIBUTE_NOT_ALLOWED_CHARACTERS_REGEX:/[^a-zA-Z0-9_]/,REPORTING_ATTRIBUTE_SPACE_REPLACEMENT_REGEX:/[^a-zA-Z0-9]+/g,REPORTING_ATTRIBUTE_MAX_LENGTH_WARNING:"Length of attribute must be between 1 and 256 characters.",REPORTING_ATTRIBUTE_PROHIBITED_CHARACTERS_WARNING:"Attribute may only contain letters, numbers, and the underscore character.",REPORTING_ATTRIBUTE_VALUE_NOT_STRING_WARNING:"Attribute must be a string and cannot be an object or array.",CHROME_EXTENSION_ID:"lfljgabnenicfhcbbfflijkeoebncchk",GDPR_VALUES:["gdpr","gdpr_pd","gdpr_consent"],CONSENT_COOKIE_NAME:"amzn_consent",CONSENT_COOKIE_TTL_IN_MS:24192e5};const o=n,r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const a=["AD","AL","AT","BA","BE","BG","BY","CH","CY","CZ","DE","DK","EE","ES","FI","FR","GB","GR","HR","HU","IE","IS","IT","LI","LT","LU","LV","MC","MD","ME","MK","MT","NL","NO","PL","PT","RO","RS","RU","SE","SI","SK","SM","UA","UK","VA"];function s(e){return!(!e||"string"!=typeof e)&&a.includes(e.toUpperCase())}var i={isEmpty:function(e){return null==e||""===e||0===Object.keys(e).length||0===e.length},isValidAdTag:function(e){return e&&r.test(e)},measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie:function(e){return e.map((e=>e.join(o.MEASUREMENT_TIMESTAMP_SEPARATOR))).join(o.MEASUREMENT_TOKEN_TIMESTAMP_PAIR_DELIMITER)},measurementTokenCookieToMeasurementTokenTimestampPairsNestedArr:function(e){return e?e.split(o.MEASUREMENT_TOKEN_TIMESTAMP_PAIR_DELIMITER).map((e=>{const[t,n]=e.split(o.MEASUREMENT_TIMESTAMP_SEPARATOR);return[t,Number(n)]})):[]},getMeasurementTokenTimestamp:function(){return window.performance&&window.performance.timeOrigin?Math.ceil(window.performance.timeOrigin):Date.now()},isEUCountry:s,getRegionFromCountryCode:function(e,t="NA"){return s(e)?"EU":t}};const E=n;function c(){}c.prototype.isCookiePresent=function(e){return document.cookie.split(";").some((t=>t.trim().startsWith(`${e}=`)))&&!c.prototype.isCookieMarkedForDeletion(e)},c.prototype.isCookieMarkedForDeletion=function(e){return"0"===c.prototype.getCookieValue(e)},c.prototype.getCookieValue=function(e){return document.cookie.split(";").find((t=>t.trim().startsWith(`${e}=`)))?.split("=")[1]},c.prototype.writeCookie=function(e,t,n){const o=new Date(n).toUTCString();document.cookie=`${e}=${t}; expires=${o}; SameSite=Strict; secure=true;`},c.prototype.deleteCookie=function(e){c.prototype.writeCookie(e,"0",E.ARBITRARY_PAST_UNIX_TIMESTAMP)};var _=c;const A=n,T=_,d=i;function u(e,t,n){e.searchParams.set(t,n);const o=Array.from(e.searchParams.entries());e.search="",o.forEach((n=>{n[0]!==t&&e.searchParams.set(n[0],n[1])})),e.search+=`&${t}=${n}`}function N(e,t,n){const o=!t||""===t.trim(),r=new URLSearchParams(window.location.search).get(A.MT_LP_QUERY_PARAM),a=new T;if(n||"EU"===t||o)return function(e,t){if(!t)return;const n=d.getMeasurementTokenTimestamp(),o=d.measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie([[t,n]]);e.searchParams.set(A.MEASUREMENT_TOKEN_SOURCE_QUERY_PARAM_NAME,"url"),e.searchParams.set(A.MEASUREMENT_TOKEN_EVENT_FIRE_URL_QUERY_PARAM_NAME,o)}(e,r),null;A.MEASUREMENT_TOKEN_FULLY_ENABLED_REGIONS.includes(t)&&function(e,t,n){let o,r=n.getCookieValue(A.MEASUREMENT_TOKEN_COOKIE_NAME);if(t){const e=[t,d.getMeasurementTokenTimestamp()];if(r){const n=d.measurementTokenCookieToMeasurementTokenTimestampPairsNestedArr(r),a=n.some((([e])=>e===t))?[e,...n.filter((([e])=>e!==t))]:[e,...n];r=d.measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie(a),o="cookie"}else r=d.measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie([e]),o="cookie"}else r&&(o="cookie");r=function(e){if(!e)return;const t=d.getMeasurementTokenTimestamp()-A.MEASUREMENT_TOKEN_TTL_IN_MS,n=d.measurementTokenCookieToMeasurementTokenTimestampPairsNestedArr(e).filter((([,e])=>e>t));return n.length>0?d.measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie(n):void 0}(r),r&&o&&(e.searchParams.set(A.MEASUREMENT_TOKEN_SOURCE_QUERY_PARAM_NAME,o),e.searchParams.set(A.MEASUREMENT_TOKEN_EVENT_FIRE_URL_QUERY_PARAM_NAME,r))}(e,r,a)}var m={createQueryParams:function(e,{tagId:t,eventName:n,eventAttributes:o,consent:r,uuid:a,amazonConsent:s,region:i}){const E="string"==typeof e?new URL(e):e;if(d.isEmpty(t))throw new Error("Tag ID is a required parameter.");if(!d.isValidAdTag(t))throw new Error("Invalid ad tag provided.");if(E.searchParams.set("pid",t),d.isEmpty(n))throw new Error("Event name is a required parameter.");E.searchParams.set("event",n),Array.isArray(o)&&u(E,"items",encodeURI(JSON.stringify(o))),o&&Object.entries(o).forEach((([e,t])=>{A.GDPR_VALUES.includes(e)||(t||""===t)&&("object"==typeof t?E.searchParams.set(e,JSON.stringify(t)):E.searchParams.set(e,String(t)))})),r&&A.GDPR_VALUES.forEach((e=>{r[e]&&E.searchParams.set(e,r[e])}));let c="EU"===i||"UK"===i,_=null;s&&(_=JSON.stringify(s),E.searchParams.set("consentString",_),"{}"!==_&&'"null"'!==_&&"undefined"!==_&&(c=!0));const m=new T;if(m.isCookiePresent(A.AMZN_TOKEN_COOKIE_NAME)){const e=m.getCookieValue(A.AMZN_TOKEN_COOKIE_NAME);e&&u(E,A.AMZN_TOKEN_URL_QUERY_PARAM_NAME,e)}return N(E,i,c?_:null),E.searchParams.set("eventSource","amzn.js"),a&&E.searchParams.set("uuid",a),E}};const{createQueryParams:l}=m,h={"Google Chrome":106,Chromium:106},p="paa-reporting-advertising.amazon";function g(e){const t="/assets/conversion_module.js";switch(e.toLowerCase()){case"beta":case"test":return`https://beta-ara.${p}${t}`;case"gamma":return`https://gamma-ara.${p}${t}`;default:return`https://ara.${p}${t}`}}function f(){const{userAgentData:e}=navigator;return null!=e&&function(e){return e.some((({brand:e,version:t})=>h[e]<=t))}(e.brands)}async function M(e,t){try{const n=g(t);if(e&&n){const t=await e.json();return t&&0!==Object.keys(t).length&&"healthy"!==t?(await(sharedStorage?.createWorklet(n,{dataOrigin:"script-origin"}))).run("conversion-module",{data:t,privateAggregationConfig:{contextId:t?.debugKey}}):Promise.resolve(!1)}}catch{}return Promise.resolve(!1)}var R={performTriggerRegistration:async function(e){const{stage:t}=e;if(!f()||!(document?.featurePolicy?.allowsFeature?.("attribution-reporting")&&document?.featurePolicy?.allowsFeature?.("private-aggregation")&&document?.featurePolicy?.allowsFeature?.("shared-storage")))return Promise.resolve(!1);const n=function(e){let t;switch(e.toLowerCase()){case"beta":case"test":t=`https://beta-ara.${p}/aat`;break;case"gamma":t=`https://gamma-ara.${p}/aat`;break;default:t=`https://ara.${p}/aat`}return new URL(t)}(t),o=l(n,e),r=await async function(e){const t={credentials:"same-origin",keepalive:!0,attributionReporting:{eventSourceEligible:!1,triggerEligible:!0}};let n;try{n=await(window?.fetch(e,t))}catch{}return n}(o.href);return M(r,t),r},generateUUID:function(){return typeof crypto<"u"&&"function"==typeof crypto.randomUUID?crypto.randomUUID():""},generateWorkletUrl:g,runSharedStorageWorklet:M};const O=n;function C(e,t,n){e.length>O.NAME_MAX_LENGTH&&t.push(`${n}, ${e}`)}var S={validateLength:C,validateEventAttributesAsArray:function(e,t){e.forEach((function(e){C(Object.keys(e)[0],t,O.EVENT_PARAMETER_NAME_EXCEEDED_MAX_LENGTH_WARNING),C(e[Object.keys(e)[0]],t,O.EVENT_PARAMETER_VALUE_EXCEEDED_MAX_LENGTH_WARNING)}))},filterGdprValuesOut:function(e){return!O.GDPR_VALUES.includes(e)},validateCustomAttributesForReporting:function(e,t){let n;const o=t[e];let r=o;const a=e.toLowerCase();return O.REPORTING_ATTRIBUTES.includes(a)&&(n={},n[a]={messages:[]},(o.length>O.REPORTING_ATTRIBUTE_MAX_LENGTH||o.length<1)&&n[a].messages.push(O.REPORTING_ATTRIBUTE_MAX_LENGTH_WARNING),"string"==typeof o?(r=r.trim(),r=o.replaceAll(O.REPORTING_ATTRIBUTE_SPACE_REPLACEMENT_REGEX,"_").trim(),O.REPORTING_ATTRIBUTE_NOT_ALLOWED_CHARACTERS_REGEX.test(r)&&n[a].messages.push(O.REPORTING_ATTRIBUTE_PROHIBITED_CHARACTERS_WARNING)):n[a].messages.push(O.REPORTING_ATTRIBUTE_VALUE_NOT_STRING_WARNING),0===n[a].messages.length?n=void 0:(n[a].value=r,r=void 0)),{eventReportingAttributeWarnings:n,newAttributeValue:r}},validateAttributeValueAsObject:function(e,t){if("object"==typeof e&&Object.keys(e)&&Object.keys(e)[0])return Object.keys(e).forEach((function(n){n.length>O.NAME_MAX_LENGTH&&t.push(`${O.EVENT_PARAMETER_KEY_EXCEEDED_MAX_LENGTH_WARNING}, ${n}`),e[n].length>O.EVENT_PARAMETER_MAX_VALUE_LENGTH&&t.push(`${O.EVENT_PARAMETER_VALUE_EXCEEDED_MAX_LENGTH_WARNING}, ${e[n]}`)})),encodeURI(JSON.stringify(e))},validateAttributeValueAsString:function(e,t){"string"==typeof e&&e.length>O.EVENT_PARAMETER_MAX_VALUE_LENGTH&&t.push(`${O.EVENT_PARAMETER_VALUE_EXCEEDED_MAX_LENGTH_WARNING}, ${e}`)}};const I=n,{isEmpty:y,isValidAdTag:k}=i,{createQueryParams:P}=m,{generateUUID:v}=R,{validateLength:U,validateEventAttributesAsArray:w,filterGdprValuesOut:L,validateCustomAttributesForReporting:D,validateAttributeValueAsString:b,validateAttributeValueAsObject:G}=S;function H(e,t){this.endpoints=e,this.region="NA",this.stage="PROD",this.tagIdsByLabels={},this.TCFv2={},this.consentHandler=t}function K(e,t,n){const o=document.createElement("iframe");o.style.display="none",o.setAttribute("src",e),o.setAttribute("id",`tag_fire_${t}_${n}_${Date.now()}`),document.body.appendChild(o)}H.prototype.addTag=function({tagId:e,tagLabel:t}){if(y(e))return void console.warn("Tag id is required for addTag command");if(!k(e))return void console.warn(`Invalid tag id provided: ${e}`);const n=y(t)?e:t;this.tagIdsByLabels[n]=e},H.prototype.getTagIds=function(e){const{tagIdsByLabels:t}=this;return e.map((function(e){return t[e]||e}))},H.prototype.trackEvent=async function(e,t,n){return this.trackEventWithTags(e,t,n,Object.keys(this.tagIdsByLabels))},H.prototype.trackRequest=async function(e,t,n,o){const r=v();let a={...this.TCFv2[e]};const s=this.consentHandler.getTcfString();this.consentHandler.isConsentSet()&&s&&(void 0===a.gdpr_consent||""===a.gdpr_consent)&&(a={gdpr:1,gdpr_pd:1,gdpr_consent:s});try{await async function({eventIngestionEndpoint:e,consent:t,eventAttributes:n,eventName:o,tagId:r,uuid:a,consentHandler:s,region:i}){const E=[],c={},_=JSON.parse(JSON.stringify(n));if(U(o,E,I.EVENT_NAME_EXCEEDED_MAX_LENGTH_WARNING),Array.isArray(n)?w(n,E):n&&Object.keys(n).filter(L).forEach((function(e){let t;U(e,E,I.EVENT_PARAMETER_NAME_EXCEEDED_MAX_LENGTH_WARNING),t=n[e];const{newAttributeValue:o,eventReportingAttributeWarnings:r}=D(e,_);if(r&&(c[e]=r[e.toLowerCase()]),o?_[e]=o:void 0===o&&delete _[e],t){b(t,E);const e=G(t,E);e&&(t=e)}else console.warn(`Key ${e} has no value`)})),E.length>0){const e=`Event has ${E.length} validation errors.`;return console.warn(e),console.warn(E),Promise.reject(e)}const A=P(new URL(e),{tagId:r,eventName:o,eventAttributes:_,consent:t,uuid:a,region:i,amazonConsent:s.getFormattedAmazonConsent(!1)}).href;if(Object.keys(c).length>0&&void 0!==window.chrome&&void 0!==window.chrome.runtime)try{window.chrome.runtime.sendMessage(I.CHROME_EXTENSION_ID,{adTagEventWarnings:!0,eventUrl:A,attributeWarnings:c})}catch{}if(!window.fetch||typeof window.fetch>"u")return K(A,r,o);try{const e=await fetch(A,{method:"get",credentials:"include",mode:"no-cors",keepalive:!0});return Promise.resolve(e)}catch{return console.warn("Event request via fetch failed, reverting to iframe"),K(A,r,o)}}({eventIngestionEndpoint:t,consent:a,eventAttributes:o,eventName:n,tagId:e,uuid:r,consentHandler:this.consentHandler,region:this.region})}catch(e){return console.warn("Event request failed.",e),Promise.reject(e)}try{const{performTriggerRegistration:t}=R;await t({stage:this.stage,consent:a,tagId:e,eventName:n,eventAttributes:o,uuid:r,region:this.region})}catch(e){console.warn("ARA trigger registration failed",e)}return Promise.resolve()},H.prototype.trackEventWithTags=async function(e,t,n,o){const r=this.getPixelEndpoint(this.region),a=t||{},s="No eventName name specified.",i="No valid endpoint.";if(!e)return console.warn(s),Promise.reject(s);if(!r)return console.warn(i),Promise.reject(i);n&&(a.ts=n);const E=this.getTagIds(o).map((t=>this.trackRequest(t,r,e,a)));return Promise.all(E)},H.prototype.trackPixel=function(e,t,n){let o;const r={};let a=t||"";a=a.split("?"),o=a.length>1?a[1]:a[0],o=o.split("&"),o.forEach((e=>{const t=e.split("=");let n,o;t.length<=1||("ex-fargs"===t[0]?(n=this.parsePixelArgs(t[1],"&"),r.fargs_id=n.id,r.fargs_type=n.type):"ex-hargs"===t[0]&&(o=this.parsePixelArgs(t[1],";"),r.hargs_c=o.c,r.hargs_p=o.p))})),this.validatePixelData(r),Object.keys(r).forEach((function(e){r[e]||delete r[e]})),this.trackEvent(e,r,n)},H.prototype.addTCFv2=function(e){this.addTCFv2WithTags(e,Object.keys(this.tagIdsByLabels))},H.prototype.addTCFv2WithTags=function(e,t){const{TCFv2:n}=this;this.getTagIds(t).forEach((function(t){n[t]=e}))},H.prototype.getPixelEndpoint=function(e){const t=this.endpoints[e.toUpperCase()];return""===t||null==t?(console.warn("Endpoint does not exist, please check your region configuration!"),null):t},H.prototype.parsePixelArgs=function(e,t){let n=decodeURIComponent(e);const o={};return n=n.replace(/\?/g,""),n.split(t).forEach((function(e){const t=e.split("=");if(t.length>1){const[e,n]=t;o[e]=n}})),o},H.prototype.validatePixelData=function(e){const t=e.hargs_c&&e.hargs_p,n=e.fargs_id&&e.fargs_type;!t&&!n&&console.warn("Invalid arguments for a trackPixel event, please check your implementation!")},H.prototype.setRegion=function(e){this.region=e},H.prototype.setStage=function(e){this.stage=e};var z=H;const F=n,{measurementTokenTimestampPairsNestedArrToMeasurementTokenCookie:V,measurementTokenCookieToMeasurementTokenTimestampPairsNestedArr:X,getMeasurementTokenTimestamp:Z}=i,B="AIPToken",j="cookieExpiry",W={method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer-when-downgrade"};function x(e){this.cookieHandler=e,this.alreadySavedMeasurementToken=!1,window.addEventListener("load",(()=>{this.alreadySavedMeasurementToken=!1}))}x.prototype.saveMeasurementTokenInURLToCookieIfPresent=function(e,t){try{if(t||-1===F.MEASUREMENT_TOKEN_FULLY_ENABLED_REGIONS.indexOf(e)||this.alreadySavedMeasurementToken)return;const n=new URLSearchParams(window.location.search).get(F.MT_LP_QUERY_PARAM);if(!n)return;let o=this.cookieHandler.getCookieValue(F.MEASUREMENT_TOKEN_COOKIE_NAME);o&&o?.split(F.MEASUREMENT_TOKEN_TIMESTAMP_PAIR_DELIMITER).length>=F.NUM_MAX_MEASUREMENT_TOKENS&&(o=V(X(o).slice(0,-1)));const r=performance&&performance.timeOrigin?Math.ceil(performance.timeOrigin):Date.now(),a=X(o||""),s=V([[n,r]].concat(a)),i=r+F.MEASUREMENT_TOKEN_TTL_IN_MS;this.cookieHandler.writeCookie(F.MEASUREMENT_TOKEN_COOKIE_NAME,s,i),this.alreadySavedMeasurementToken=!0}catch(e){console.error("[AAT] Error saving measurement token from URL to cookie:",e)}},x.prototype.removeAnyExpiredMeasurementTokens=function(){try{const e=this.cookieHandler.getCookieValue(F.MEASUREMENT_TOKEN_COOKIE_NAME);if(!e)return;const t=Z()-F.MEASUREMENT_TOKEN_TTL_IN_MS,n=X(e).filter((([,e])=>e>t));if(0===n.length)return this.cookieHandler.deleteCookie(F.MEASUREMENT_TOKEN_COOKIE_NAME),void(this.alreadySavedMeasurementToken=!1);const o=V(n),r=n[F.NEWEST_MEASUREMENT_TOKEN_INDEX][F.MT_TS_PAIR_TS_INDEX]+F.MEASUREMENT_TOKEN_TTL_IN_MS;this.cookieHandler.writeCookie(F.MEASUREMENT_TOKEN_COOKIE_NAME,o,r)}catch{}},x.prototype.formatRequestBody=function(e){const t={};if(null!==e.gdpr&&(t.gdpr=e.gdpr.enabled?1:0,null!==e.gdpr.consent&&(t.gdprConsent=e.gdpr.consent)),null===e.hashedRecords)throw Error("hashedRecords array is null");if(0===e.hashedRecords.length)throw Error("hashedRecords array is empty");return t.hashedRecords=e.hashedRecords,null!==e.ttl&&(t.ttl=e.ttl),void 0!==e.consentString&&(t[F.AIPES_AMAZON_CONSENT_STRING_FIELD_NAME]=e.consentString),t},x.prototype.requestAmznToken=async function(e){const t={...W,body:JSON.stringify(e)},n=await fetch("https://tk.amazon-adsystem.com/envelope",t);if(n.ok)return await n.json();const o=await n.text();throw Error(o)},x.prototype.renewAmznToken=async function(e){if(!this.cookieHandler.isCookiePresent(F.AMZN_TOKEN_COOKIE_NAME)&&!this.cookieHandler.isCookiePresent(F.NO_CONSENT_COOKIE_NAME))try{const t=this.formatRequestBody(e),n=await this.requestAmznToken(t);return""===n[B]?this.cookieHandler.writeCookie(F.NO_CONSENT_COOKIE_NAME,n[B],n[j]):this.cookieHandler.writeCookie(F.AMZN_TOKEN_COOKIE_NAME,n[B],n[j]),n}catch(e){console.error(e)}return"no-op"},x.prototype.deleteAmznToken=async function(){this.cookieHandler.isCookiePresent(F.AMZN_TOKEN_COOKIE_NAME)&&this.cookieHandler.deleteCookie(F.AMZN_TOKEN_COOKIE_NAME),this.cookieHandler.isCookiePresent(F.NO_CONSENT_COOKIE_NAME)&&this.cookieHandler.deleteCookie(F.NO_CONSENT_COOKIE_NAME)},x.prototype.updateAmznToken=async function(e){return await this.deleteAmznToken(),this.renewAmznToken(e)};var $=x;function Y(e,t){this.tokensHandler=e,this.consentHandler=t}async function Q(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function q(e){return null!=e&&"string"==typeof e&&e.length>0}Y.prototype.setUserData=async function(e){const t={gdpr:{enabled:!1,consent:""},hashedRecords:[],ttl:9600},n=e[1];n.gdpr&&(t.gdpr=n.gdpr),n.ttl&&(t.ttl=n.ttl);const o=/[A-Fa-f0-9]{64}/;if(q(n.email)){const e={type:"email",record:""};n.email=n.email.trim().toLowerCase(),o.test(n.email)?e.record=n.email:e.record=await Q(n.email),t.hashedRecords.push(e)}if(q(n.phonenumber)){const e={type:"phonenumber",record:""};o.test(n.phonenumber)?e.record=n.phonenumber:e.record=await Q(function(e){let t=e.replace(/[^\d+]+/g,"");return t=t.replace(/^00/,"+"),t.match(/^1/)&&(t=`+${t}`),t.match(/^\+/)||(t=`+1${t}`),t=t.replace(/^\+/,""),t}(n.phonenumber)),t.hashedRecords.push(e)}if(this.consentHandler.isConsentSet()&&this.consentHandler.isAipesEgressEnabled()){t.consentString=this.consentHandler.getFormattedAmazonConsent(!1);const e=this.consentHandler.getTcfString();void 0!==e&&""!==e&&""===t.gdpr.consent&&(t.gdpr.enabled=!0,t.gdpr.consent=e)}return t.hashedRecords.length>0?this.tokensHandler.updateAmznToken(t):Promise.resolve()};var J=Y;const{isEUCountry:ee}=i,te=n;function ne(e,t,n,o,r){this.eventTracker=e,this.setUserDataHandler=t,this.tokensHandler=n,this.aatEventsQueue=[],this.isSetUserDataInProcess=!1,this.consentHandler=r}ne.prototype.processCommandQueue=async function(e){return Promise.all((e||[]).map((e=>this.processCommand(e[0],e[1]))))},ne.prototype.processCommand=async function(e,t=Date.now()){const n=Array.prototype.slice.call(e),o=e[0],r=`Unsupported tag command "${o}"`,a={trackevent:(e,t)=>this.trackEvent(e,t),trackpixel:(e,t)=>this.trackPixel(e,t),pixel:(e,t)=>this.withTag(e,t),withtag:(e,t)=>this.withTag(e,t),addpixel:e=>this.addTag(e),addtag:e=>this.addTag(e),addtcfv2:e=>this.addTCFv2(e),setregion:e=>this.setRegion(e),setstage:e=>this.setStage(e),setuserdata:e=>this.setUserData(e)},s=o.toLowerCase();return a[s]?a[s](n,t):(console.warn(r),Promise.reject(r))},ne.prototype.setUserData=async function(e){this.isSetUserDataInProcess=!0;try{await this.setUserDataHandler.setUserData(e),this.isSetUserDataInProcess=!1,this.processAatEventsQueue()}catch(e){return console.warn(e),Promise.reject(e)}return Promise.resolve()},ne.prototype.processAatEventsQueue=function(){if(this.aatEventsQueue.length)for(;this.aatEventsQueue.length;){const{argumentArray:e,timestamp:t,tagLabel:n}=this.aatEventsQueue.pop();this.trackEvent(e,t,n).catch((e=>{console.warn(e)}))}},ne.prototype.trackEvent=async function(e,t,n){if(this.isSetUserDataInProcess)return this.aatEventsQueue.unshift({argumentArray:e,timestamp:t,tagLabel:n}),Promise.resolve();this.tokensHandler.removeAnyExpiredMeasurementTokens();const o=e[1],r=e[2];return void 0!==n?this.eventTracker.trackEventWithTags(o,r,t,[n]):this.eventTracker.trackEvent(o,r,t)},ne.prototype.trackPixel=function(e,t){this.eventTracker.trackPixel("__pixel__",e[1],t)},ne.prototype.withTag=async function(e,t){const n=e[1],o=e[2]||"",r=`Unsupported command "${o}" used after "withTag" command`;switch(o.toUpperCase()){case"TRACKEVENT":return this.trackEvent(e.slice(2),t,n);case"ADDTCFV2":this.addTCFv2(e.slice(2),n);break;default:return console.warn(r),Promise.reject(r)}return Promise.resolve()},ne.prototype.addTag=function(e){const t=e[2],n=e[1];this.eventTracker.addTag({tagId:n,tagLabel:t})},ne.prototype.addTCFv2=function(e,t){const n=e[1];void 0!==t?this.eventTracker.addTCFv2WithTags(n,[t]):this.eventTracker.addTCFv2(n)},ne.prototype.setRegion=async function(e){const t=e[1].toUpperCase();let n=null;try{n=(await fetch(te.MEASUREMENT_TOKEN_FETCH_COUNTRY_HEADER,{method:"get",credentials:"include",mode:"no-cors",keepalive:!0})).headers.get("x-viewer-country")}catch(e){console.warn("[AAT] Error fetching country code from headers:",e)}let o=null,r=!1;try{if(this.consentHandler&&this.consentHandler.isConsentSet()){r=!0;const e=this.consentHandler.getFormattedAmazonConsent(!1);e&&e.geo&&e.geo.countryCode&&(o=e.geo.countryCode)}}catch(e){console.warn("[AAT] Error checking Amazon consent or getting country code:",e)}let a=t;n&&ee(n)&&(a="EU"),o&&ee(o)&&(a="EU");try{this.eventTracker.setRegion(a)}catch(e){console.warn("[AAT] Error setting region in event tracker:",e)}try{this.tokensHandler.saveMeasurementTokenInURLToCookieIfPresent(a,r)}catch(e){console.warn("Error saving measurement token in URL to cookie:",e)}},ne.prototype.setStage=function(e){const t=e[1].toUpperCase();this.eventTracker.setStage(t)},ne.prototype.listen=function(){this.eventListener.init()},ne.prototype.setAmazonConsent=function(e){this.consentHandler.setAmazonConsent(e[1])};var oe=ne;const re=n;function ae(e){this.amazonConsent=void 0,this.cookieHandler=e}ae.prototype.init=function(){try{const e=this.cookieHandler.getCookieValue(re.CONSENT_COOKIE_NAME);if(e){const t=JSON.parse(decodeURIComponent(e));this.setAmazonConsent({...t,AMAZON_CONSENT_AIPES_ENABLED:!0})}}catch(e){console.warn("Error reading consent cookie:",e)}window.addEventListener("amznConsentChange",(e=>{this.setAmazonConsent({...e?.detail?.consent,AMAZON_CONSENT_AIPES_ENABLED:!0})}))},ae.prototype.setAmazonConsent=function(e){this.amazonConsent=e},ae.prototype.isConsentSet=function(){return void 0!==this.amazonConsent},ae.prototype.isAipesEgressEnabled=function(){return this.amazonConsent.AMAZON_CONSENT_AIPES_ENABLED},ae.prototype.getFormattedAmazonConsent=function(e){if(void 0===this.amazonConsent)return;const t={},n={};return void 0!==this.amazonConsent.geo&&(t[re.AIPES_AMAZON_CONSENT_GEO_FIELD_NAME]=function(e){const t={};return void 0!==e.countryCode&&(t[re.AIPES_AMAZON_CONSENT_COUNTRY_CODE_FIELD_NAME]=e.countryCode),void 0!==e.ipAddress&&(t[re.AIPES_AMAZON_CONSENT_IP_ADDRESS_FIELD_NAME]=e.ipAddress),t}(this.amazonConsent.geo)),void 0!==this.amazonConsent.amazonConsentFormat&&(n[re.AIPES_AMAZON_CONSENT_AMAZON_CONSENT_FIELD_NAME]=function(e){const t={};return void 0!==e.amznAdStorage&&(t[re.AIPES_AMAZON_CONSENT_AD_STORAGE_FIELD_NAME]=e.amznAdStorage),void 0!==e.amznUserData&&(t[re.AIPES_AMAZON_CONSENT_USER_DATA_FIELD_NAME]=e.amznUserData),t}(this.amazonConsent.amazonConsentFormat)),void 0!==this.amazonConsent.gpp&&(n[re.AIPES_AMAZON_CONSENT_GPP_FIELD_NAME]=this.amazonConsent.gpp),e&&void 0!==this.amazonConsent.tcf&&(n[re.AIPES_AMAZON_CONSENT_TCF_FIELD_NAME]=this.amazonConsent.tcf),t[re.AIPES_AMAZON_CONSENT_CONSENT_FIELD_NAME]=n,t},ae.prototype.getTcfString=function(){if(void 0!==this.amazonConsent)return this.amazonConsent.tcf};const se={NA:"https://s.amazon-adsystem.com/iu3",EU:"https://aax-eu.amazon-adsystem.com/s/iu3",FE:"https://aax-fe.amazon-adsystem.com/s/iu3"},ie=z,Ee=_,ce=$,_e=J,Ae=oe,Te=ae,de=i,{MEASUREMENT_TOKEN_FETCH_COUNTRY_HEADER:ue}=n;!async function(){const e=new Ee,t=new Te(e);t.init();const n=new ie(se,t),o=new ce(e),r=new _e(o,t);let a=new Ae(n,r,o,void 0,t);if(void 0!==window.__tcfapi){const e=(e,n)=>{n&&"tcloaded"===e.eventStatus&&t.setAmazonConsent({tcf:e.tcString})};window.__tcfapi("addEventListener",2,e)}if(void 0!==window.__gpp){const e=()=>{const e=window.__gpp("getGPPString");void 0!==e&&t.setAmazonConsent({gpp:e})};window.__gpp("addEventListener",e,"tcfeuv2")}o.removeAnyExpiredMeasurementTokens();try{const e=(await fetch(ue)).headers.get("x-viewer-country");e&&de.isEUCountry(e)&&n.setRegion("EU")}catch(e){console.warn("Error fetching country code from headers:",e)}window.amzn&&window.amzn.q&&a.processCommandQueue(window.amzn.q).catch((e=>{console.error("Error processing event queue",e)})),window.amzn=async function(...e){return a.processCommand(e).catch((e=>{console.error("Error processing command",e)}))},window.renewToken=async function(e){return o.renewAmznToken(e)},window.updateToken=async function(e){return o.updateAmznToken(e)},window.deleteToken=async function(){return o.deleteAmznToken()}}()}();
